<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CrownyDEX â€” ê±°ë˜ì†Œ</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--bg2:#111827;--bg3:#1a2236;--bg4:#222d44;
  --green:#00e676;--green2:#00c853;--greendim:rgba(0,230,118,.12);
  --red:#ff5252;--reddim:rgba(255,82,82,.12);
  --orange:#ff9800;--orangedim:rgba(255,152,0,.12);
  --cyan:#00bcd4;--purple:#7c4dff;
  --text:#e8eaed;--text2:#9ca3af;--text3:#6b7280;
  --border:#1e2a3a;--glow:0 0 20px rgba(0,230,118,.15);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;overflow:hidden}
.mono{font-family:'JetBrains Mono',monospace}

/* â”€â”€â”€ Layout â”€â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh}
header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg2);border-bottom:1px solid var(--border);height:48px;flex-shrink:0}
header .logo{font-weight:700;font-size:16px;color:var(--green);display:flex;align-items:center;gap:8px}
header .logo span{opacity:.5;font-size:12px;color:var(--text2)}
header .nav{display:flex;gap:4px}
header .nav a{padding:6px 14px;border-radius:6px;color:var(--text2);text-decoration:none;font-size:13px;font-weight:500;transition:all .2s}
header .nav a:hover,header .nav a.active{background:var(--greendim);color:var(--green)}
header .status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3)}
header .status .dot{width:6px;height:6px;border-radius:50%;background:var(--red)}
header .status .dot.on{background:var(--green);box-shadow:0 0 8px var(--green)}

.main{display:flex;flex:1;overflow:hidden}

/* â”€â”€â”€ Left Panel: Pools â”€â”€â”€ */
.panel-left{width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.panel-title{padding:10px 14px;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border)}
.pool-list{flex:1;overflow-y:auto}
.pool-item{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .15s}
.pool-item:hover{background:rgba(255,255,255,.03)}
.pool-item.active{background:var(--greendim);border-left:2px solid var(--green)}
.pool-item .pair{font-weight:600;font-size:13px}
.pool-item .meta{display:flex;justify-content:space-between;margin-top:4px;font-size:11px;color:var(--text3)}
.pool-item .price{font-family:'JetBrains Mono',monospace;color:var(--green);font-size:12px;font-weight:500}
.pool-item .liq{color:var(--text3)}
.pool-item .change{font-size:10px;padding:2px 5px;border-radius:3px}
.pool-item .change.up{background:var(--greendim);color:var(--green)}
.pool-item .change.down{background:var(--reddim);color:var(--red)}

/* Balance bar */
.balance-bar{padding:10px 14px;border-top:1px solid var(--border);background:var(--bg)}
.balance-bar .label{font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:6px}
.bal-row{display:flex;justify-content:space-between;font-size:11px;padding:2px 0}
.bal-row .sym{color:var(--text2)}
.bal-row .amt{font-family:'JetBrains Mono',monospace;color:var(--text)}

/* â”€â”€â”€ Center Panel: Chart + Orderbook â”€â”€â”€ */
.panel-center{flex:1;display:flex;flex-direction:column;min-width:0}
.chart-header{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid var(--border);background:var(--bg2)}
.chart-pair{font-size:18px;font-weight:700;color:var(--text)}
.chart-price{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:600;color:var(--green)}
.chart-info{display:flex;gap:16px;font-size:11px;color:var(--text3)}
.chart-info span b{color:var(--text2)}
.chart-intervals{display:flex;gap:2px}
.chart-intervals button{padding:4px 10px;border:none;background:transparent;color:var(--text3);font-size:11px;border-radius:4px;cursor:pointer;font-family:'Outfit',sans-serif}
.chart-intervals button.active{background:var(--greendim);color:var(--green)}

.chart-area{flex:1;position:relative;background:var(--bg);min-height:200px}
.chart-area canvas{width:100%;height:100%}

/* Orderbook */
.orderbook-area{height:280px;border-top:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2)}
.ob-header{display:flex;justify-content:space-between;padding:6px 14px;font-size:11px;color:var(--text3);border-bottom:1px solid var(--border)}
.ob-body{flex:1;display:flex;overflow:hidden}
.ob-side{flex:1;display:flex;flex-direction:column;overflow:hidden}
.ob-side.asks{border-right:1px solid var(--border)}
.ob-row{display:flex;align-items:center;padding:2px 14px;font-size:11px;font-family:'JetBrains Mono',monospace;position:relative}
.ob-row .depth{position:absolute;right:0;top:0;bottom:0;opacity:.12}
.ob-row.ask .depth{background:var(--red)}
.ob-row.bid .depth{background:var(--green)}
.ob-row .price{width:40%;z-index:1}
.ob-row .amount{width:30%;text-align:right;z-index:1;color:var(--text2)}
.ob-row .total{width:30%;text-align:right;z-index:1;color:var(--text3)}
.ob-row.ask .price{color:var(--red)}
.ob-row.bid .price{color:var(--green)}
.ob-spread{padding:4px 14px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--bg)}

/* â”€â”€â”€ Right Panel: Trade â”€â”€â”€ */
.panel-right{width:320px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.trade-tabs{display:flex;border-bottom:1px solid var(--border)}
.trade-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:var(--text3);transition:all .2s;border-bottom:2px solid transparent}
.trade-tab.active{color:var(--green);border-bottom-color:var(--green)}
.trade-tab:hover{color:var(--text)}

.trade-body{flex:1;padding:14px;overflow-y:auto}
.trade-section{margin-bottom:16px}
.trade-label{font-size:11px;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.trade-input-wrap{position:relative;margin-bottom:10px}
.trade-input{width:100%;padding:10px 12px;padding-right:60px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;outline:none;transition:border .2s}
.trade-input:focus{border-color:var(--green);box-shadow:0 0 0 2px rgba(0,230,118,.1)}
.trade-input-unit{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--text3);font-weight:600}
.trade-max{position:absolute;right:60px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--green);cursor:pointer;padding:2px 6px;border-radius:3px;background:var(--greendim)}

.trade-preview{background:var(--bg);border-radius:8px;padding:10px 12px;margin:10px 0;font-size:11px}
.trade-preview .row{display:flex;justify-content:space-between;padding:3px 0}
.trade-preview .row .lbl{color:var(--text3)}
.trade-preview .row .val{font-family:'JetBrains Mono',monospace;color:var(--text2)}

.trade-btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s;margin-top:8px}
.trade-btn.buy{background:var(--green);color:#000}
.trade-btn.buy:hover{box-shadow:var(--glow);filter:brightness(1.1)}
.trade-btn.sell{background:var(--red);color:#fff}
.trade-btn.sell:hover{box-shadow:0 0 20px rgba(255,82,82,.3)}
.trade-btn:disabled{opacity:.4;cursor:not-allowed}

.side-toggle{display:flex;border-radius:8px;overflow:hidden;margin-bottom:12px;border:1px solid var(--border)}
.side-toggle button{flex:1;padding:8px;border:none;background:transparent;color:var(--text3);font-weight:600;font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif;transition:all .2s}
.side-toggle button.active.buy-side{background:var(--green);color:#000}
.side-toggle button.active.sell-side{background:var(--red);color:#fff}

/* Recent trades */
.recent-trades{border-top:1px solid var(--border);padding:10px 14px;max-height:180px;overflow-y:auto}
.recent-trades .title{font-size:11px;color:var(--text3);margin-bottom:6px;text-transform:uppercase}
.rt-row{display:flex;justify-content:space-between;font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 0}
.rt-row .trit{width:14px}
.rt-row.buy .price{color:var(--green)}
.rt-row.sell .price{color:var(--red)}
.rt-row .time{color:var(--text3)}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Background glow */
.glow-bg{position:fixed;top:-200px;left:50%;width:600px;height:600px;background:radial-gradient(circle,rgba(0,230,118,.04),transparent 70%);pointer-events:none;z-index:0;transform:translateX(-50%)}

/* Responsive */
@media(max-width:1024px){.panel-left{width:200px}.panel-right{width:280px}}
@media(max-width:768px){
  .main{flex-direction:column}
  .panel-left{width:100%;height:auto;max-height:120px;flex-direction:row;overflow-x:auto}
  .pool-list{display:flex;flex-direction:row}.pool-item{min-width:140px}
  .panel-right{width:100%;height:auto}
  .balance-bar{display:none}
}
</style>
</head>
<body>
<div class="glow-bg"></div>
<div id="app">
  <!-- Header -->
  <header>
    <div class="logo">â–³ CrownyDEX <span>v1.0</span></div>
    <div class="nav">
      <a href="/dex" class="active">ğŸ’± DEX</a>
      <a href="/ai">ğŸ¤– AI</a>
      <a href="/">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
    </div>
    <div class="status">
      <div class="dot" id="wsDot"></div>
      <span id="wsStatus">ì—°ê²° ì¤‘...</span>
    </div>
  </header>

  <div class="main">
    <!-- Left: Pool List -->
    <div class="panel-left">
      <div class="panel-title">ìœ ë™ì„± í’€</div>
      <div class="pool-list" id="poolList"></div>
      <div class="balance-bar" id="balanceBar">
        <div class="label">ë‚´ ì”ì•¡ (user1)</div>
        <div id="balances"></div>
      </div>
    </div>

    <!-- Center: Chart + Orderbook -->
    <div class="panel-center">
      <div class="chart-header">
        <div>
          <div class="chart-pair" id="chartPair">CRWN / USDT</div>
          <div class="chart-info">
            <span>24h Vol: <b id="chartVol">0</b></span>
            <span>Swaps: <b id="chartSwaps">0</b></span>
            <span>Fee: <b id="chartFee">0.30%</b></span>
            <span>TVL: <b id="chartTVL">0</b></span>
          </div>
        </div>
        <div style="text-align:right">
          <div class="chart-price" id="chartPrice">$0.1250</div>
          <div class="chart-intervals">
            <button class="active" data-tf="price">Price</button>
            <button data-tf="depth">Depth</button>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <canvas id="priceChart"></canvas>
      </div>
      <div class="orderbook-area">
        <div class="ob-header">
          <span>ì˜¤ë”ë¶ â€” <span id="obPool" class="mono">CRWN-USDT</span></span>
          <span id="obCount">0 orders</span>
        </div>
        <div class="ob-body">
          <div class="ob-side asks" id="obAsks"></div>
          <div class="ob-side bids" id="obBids"></div>
        </div>
        <div class="ob-spread" id="obSpread">ìŠ¤í”„ë ˆë“œ: â€”</div>
      </div>
    </div>

    <!-- Right: Trade Panel -->
    <div class="panel-right">
      <div class="trade-tabs">
        <div class="trade-tab active" data-tab="swap">âš¡ ìŠ¤ì™‘</div>
        <div class="trade-tab" data-tab="limit">ğŸ“‹ ë¦¬ë°‹</div>
      </div>

      <!-- Swap Tab -->
      <div class="trade-body" id="swapTab">
        <div class="trade-section">
          <div class="trade-label">ë³´ë‚´ëŠ” í† í°</div>
          <div class="trade-input-wrap">
            <input type="number" class="trade-input" id="swapAmount" placeholder="0.00" oninput="previewSwap()">
            <span class="trade-max" onclick="setMaxSwap()">MAX</span>
            <span class="trade-input-unit" id="swapInUnit">CRWN</span>
          </div>
        </div>
        <div style="text-align:center;padding:4px;color:var(--text3);font-size:18px;cursor:pointer" onclick="flipSwap()">â‡…</div>
        <div class="trade-section">
          <div class="trade-label">ë°›ëŠ” í† í°</div>
          <div class="trade-input-wrap">
            <input type="number" class="trade-input" id="swapOut" placeholder="0.00" readonly style="opacity:.7">
            <span class="trade-input-unit" id="swapOutUnit">USDT</span>
          </div>
        </div>
        <div class="trade-preview" id="swapPreview" style="display:none">
          <div class="row"><span class="lbl">í™˜ìœ¨</span><span class="val" id="prevRate">â€”</span></div>
          <div class="row"><span class="lbl">ìˆ˜ìˆ˜ë£Œ (0.3%)</span><span class="val" id="prevFee">â€”</span></div>
          <div class="row"><span class="lbl">ìŠ¬ë¦¬í”¼ì§€</span><span class="val" id="prevSlip">â€”</span></div>
          <div class="row"><span class="lbl">ìµœì†Œ ìˆ˜ë ¹ëŸ‰</span><span class="val" id="prevMin">â€”</span></div>
        </div>
        <button class="trade-btn buy" id="swapBtn" onclick="executeSwap()" disabled>ìŠ¤ì™‘ ì‹¤í–‰</button>
      </div>

      <!-- Limit Tab -->
      <div class="trade-body" id="limitTab" style="display:none">
        <div class="side-toggle">
          <button class="active buy-side" id="limitBuyBtn" onclick="setLimitSide('buy')">ë§¤ìˆ˜ BUY</button>
          <button id="limitSellBtn" onclick="setLimitSide('sell')">ë§¤ë„ SELL</button>
        </div>
        <div class="trade-section">
          <div class="trade-label">ì£¼ë¬¸ ê°€ê²©</div>
          <div class="trade-input-wrap">
            <input type="number" class="trade-input" id="limitPrice" placeholder="0.00" step="0.0001">
            <span class="trade-input-unit" id="limitPriceUnit">USDT</span>
          </div>
        </div>
        <div class="trade-section">
          <div class="trade-label">ìˆ˜ëŸ‰</div>
          <div class="trade-input-wrap">
            <input type="number" class="trade-input" id="limitAmount" placeholder="0">
            <span class="trade-input-unit" id="limitAmountUnit">CRWN</span>
          </div>
        </div>
        <div class="trade-preview">
          <div class="row"><span class="lbl">ì´ ê¸ˆì•¡</span><span class="val" id="limitTotal">â€”</span></div>
        </div>
        <button class="trade-btn buy" id="limitBtn" onclick="executeLimitOrder()">ë§¤ìˆ˜ ì£¼ë¬¸</button>
      </div>

      <!-- Recent Trades -->
      <div class="recent-trades">
        <div class="title">ìµœê·¼ ê±°ë˜</div>
        <div id="recentTrades"></div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CrownyDEX GUI â€” Client Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = '';
let ws = null;
let pools = [];
let balances = {};
let selectedPool = 'CRWN-USDT';
let swapDirection = 'AtoB'; // AtoB or BtoA
let limitSide = 'buy';
let priceHistory = [];
let recentTradesList = [];

// â”€â”€â”€ WebSocket â”€â”€â”€
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}`);
  ws.onopen = () => {
    document.getElementById('wsDot').classList.add('on');
    document.getElementById('wsStatus').textContent = 'ì—°ê²°ë¨';
  };
  ws.onclose = () => {
    document.getElementById('wsDot').classList.remove('on');
    document.getElementById('wsStatus').textContent = 'ì¬ì—°ê²° ì¤‘...';
    setTimeout(connectWS, 3000);
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'dex_update') handleDexUpdate(msg.data);
    if (msg.type === 'swap') handleSwapEvent(msg.data);
    if (msg.type === 'order') handleOrderEvent(msg.data);
  };
}

function handleDexUpdate(data) {
  data.forEach(update => {
    const pool = pools.find(p => p.id === update.id);
    if (pool) {
      pool.price = update.price;
      pool.reserveA = update.reserveA;
      pool.reserveB = update.reserveB;
      pool.swapCount = update.swaps;
      pool.volume24h = update.volume;
    }
    if (update.id === selectedPool) {
      priceHistory.push({ time: Date.now(), price: update.price });
      if (priceHistory.length > 200) priceHistory.shift();
    }
  });
  renderPools();
  renderChart();
  updateChartHeader();
}

function handleSwapEvent(data) {
  recentTradesList.unshift({
    ...data,
    time: new Date(),
    trit: data.slippage < 0.005 ? 'â–³' : data.slippage < 0.02 ? 'â—‹' : 'â–½'
  });
  if (recentTradesList.length > 30) recentTradesList.pop();
  renderRecentTrades();
  loadBalances();
}

function handleOrderEvent(data) {
  loadOrderbook();
}

// â”€â”€â”€ API â”€â”€â”€
async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function postJSON(url, body) {
  const r = await fetch(API + url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  return r.json();
}

// â”€â”€â”€ Data Loading â”€â”€â”€
async function loadPools() {
  const data = await fetchJSON('/api/dex/pools');
  pools = data.pools || [];
  renderPools();
  selectPool(selectedPool);
}

async function loadBalances() {
  const data = await fetchJSON('/api/dex/balances?user=user1');
  balances = data.balances || {};
  renderBalances();
}

async function loadOrderbook() {
  const data = await fetchJSON(`/api/dex/orderbook?pool=${selectedPool}`);
  renderOrderbook(data.orders || []);
}

async function loadHistory() {
  const data = await fetchJSON('/api/dex/history?limit=30');
  recentTradesList = (data.swaps || []).reverse().map(s => ({
    ...s,
    time: new Date(s.timestamp || Date.now()),
    trit: 'â—‹'
  }));
  renderRecentTrades();
}

// â”€â”€â”€ Pool Selection â”€â”€â”€
function selectPool(poolId) {
  selectedPool = poolId;
  const pool = pools.find(p => p.id === poolId);
  if (!pool) return;
  
  priceHistory = (pool.priceHistory || []).map((p, i) => ({ time: Date.now() - (pool.priceHistory.length - i) * 5000, price: p }));
  
  const [tA, tB] = poolId.split('-');
  document.getElementById('chartPair').textContent = `${tA} / ${tB}`;
  document.getElementById('obPool').textContent = poolId;
  
  if (swapDirection === 'AtoB') {
    document.getElementById('swapInUnit').textContent = tA;
    document.getElementById('swapOutUnit').textContent = tB;
  } else {
    document.getElementById('swapInUnit').textContent = tB;
    document.getElementById('swapOutUnit').textContent = tA;
  }
  document.getElementById('limitPriceUnit').textContent = tB;
  document.getElementById('limitAmountUnit').textContent = tA;
  
  updateChartHeader();
  renderChart();
  renderPools();
  loadOrderbook();
  previewSwap();
}

function updateChartHeader() {
  const pool = pools.find(p => p.id === selectedPool);
  if (!pool) return;
  
  const price = pool.price;
  const [tA, tB] = selectedPool.split('-');
  let priceStr;
  if (tB === 'KRW') priceStr = 'â‚©' + fmtN(price, 1);
  else if (tB === 'BTC') priceStr = price.toFixed(8) + ' BTC';
  else if (tB === 'ETH') priceStr = price.toFixed(6) + ' ETH';
  else priceStr = '$' + fmtN(price, 4);
  
  document.getElementById('chartPrice').textContent = priceStr;
  document.getElementById('chartVol').textContent = fmtN(pool.volume24h, 0);
  document.getElementById('chartSwaps').textContent = pool.swapCount;
  document.getElementById('chartFee').textContent = (pool.feeBps / 100).toFixed(2) + '%';
  
  const tvl = pool.reserveA + pool.reserveB * (1 / pool.price);
  document.getElementById('chartTVL').textContent = fmtN(tvl, 0);
}

// â”€â”€â”€ Rendering â”€â”€â”€
function renderPools() {
  const el = document.getElementById('poolList');
  el.innerHTML = pools.map(p => {
    const active = p.id === selectedPool ? 'active' : '';
    const [tA, tB] = p.id.split('-');
    let priceStr;
    if (tB === 'KRW') priceStr = 'â‚©' + fmtN(p.price, 1);
    else if (tB === 'BTC') priceStr = p.price.toFixed(8);
    else if (tB === 'ETH') priceStr = p.price.toFixed(6);
    else priceStr = '$' + fmtN(p.price, 4);
    
    const change = priceHistory.length > 10 ? ((p.price - priceHistory[0].price) / priceHistory[0].price * 100) : 0;
    const chCls = change >= 0 ? 'up' : 'down';
    const chStr = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
    
    return `<div class="pool-item ${active}" onclick="selectPool('${p.id}')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="pair">${tA}/${tB}</span>
        <span class="change ${chCls}">${chStr}</span>
      </div>
      <div class="meta">
        <span class="price">${priceStr}</span>
        <span class="liq">TVL ${fmtCompact(p.reserveB * 2)}</span>
      </div>
    </div>`;
  }).join('');
}

function renderBalances() {
  const el = document.getElementById('balances');
  const tokens = ['CRWN', 'USDT', 'ETH', 'BTC', 'KRW'];
  el.innerHTML = tokens.filter(t => balances[t]).map(t => 
    `<div class="bal-row"><span class="sym">${t}</span><span class="amt">${fmtN(balances[t], t === 'BTC' ? 4 : t === 'ETH' ? 2 : 0)}</span></div>`
  ).join('');
}

function renderOrderbook(orders) {
  const asks = orders.filter(o => o.side === 'sell').sort((a,b) => a.price - b.price).slice(0, 10);
  const bids = orders.filter(o => o.side === 'buy').sort((a,b) => b.price - a.price).slice(0, 10);
  
  const maxAsk = Math.max(...asks.map(o => o.remaining), 1);
  const maxBid = Math.max(...bids.map(o => o.remaining), 1);
  
  document.getElementById('obAsks').innerHTML = '<div style="padding:4px 14px;font-size:10px;color:var(--text3);border-bottom:1px solid var(--border)"><span style="width:40%;display:inline-block">ë§¤ë„ ê°€ê²©</span><span style="width:30%;display:inline-block;text-align:right">ìˆ˜ëŸ‰</span><span style="width:30%;display:inline-block;text-align:right">ì´ì•¡</span></div>' +
    (asks.length ? asks.reverse().map(o => {
      const pct = (o.remaining / maxAsk * 100).toFixed(0);
      return `<div class="ob-row ask"><div class="depth" style="width:${pct}%"></div><span class="price">${fmtN(o.price, 4)}</span><span class="amount">${fmtN(o.remaining, 0)}</span><span class="total">${fmtN(o.price * o.remaining, 2)}</span></div>`;
    }).join('') : '<div style="padding:20px;text-align:center;color:var(--text3);font-size:11px">ë§¤ë„ ì£¼ë¬¸ ì—†ìŒ</div>');
  
  document.getElementById('obBids').innerHTML = '<div style="padding:4px 14px;font-size:10px;color:var(--text3);border-bottom:1px solid var(--border)"><span style="width:40%;display:inline-block">ë§¤ìˆ˜ ê°€ê²©</span><span style="width:30%;display:inline-block;text-align:right">ìˆ˜ëŸ‰</span><span style="width:30%;display:inline-block;text-align:right">ì´ì•¡</span></div>' +
    (bids.length ? bids.map(o => {
      const pct = (o.remaining / maxBid * 100).toFixed(0);
      return `<div class="ob-row bid"><div class="depth" style="width:${pct}%"></div><span class="price">${fmtN(o.price, 4)}</span><span class="amount">${fmtN(o.remaining, 0)}</span><span class="total">${fmtN(o.price * o.remaining, 2)}</span></div>`;
    }).join('') : '<div style="padding:20px;text-align:center;color:var(--text3);font-size:11px">ë§¤ìˆ˜ ì£¼ë¬¸ ì—†ìŒ</div>');
  
  document.getElementById('obCount').textContent = `${orders.length} orders`;
  
  if (asks.length && bids.length) {
    const spread = asks[0].price - bids[0].price;
    const spreadPct = (spread / asks[0].price * 100).toFixed(2);
    document.getElementById('obSpread').textContent = `ìŠ¤í”„ë ˆë“œ: ${fmtN(spread, 4)} (${spreadPct}%)`;
  }
}

function renderRecentTrades() {
  const el = document.getElementById('recentTrades');
  el.innerHTML = recentTradesList.slice(0, 15).map(t => {
    const cls = t.trit === 'â–³' ? 'buy' : t.trit === 'â–½' ? 'sell' : 'buy';
    const tritColor = t.trit === 'â–³' ? 'var(--green)' : t.trit === 'â–½' ? 'var(--red)' : 'var(--orange)';
    const time = t.time instanceof Date ? t.time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '--:--';
    return `<div class="rt-row ${cls}">
      <span class="trit" style="color:${tritColor}">${t.trit}</span>
      <span class="price">${fmtN(t.amountIn || 0, 0)} â†’ ${fmtN(t.amountOut || 0, 0)}</span>
      <span class="time">${time}</span>
    </div>`;
  }).join('');
}

// â”€â”€â”€ Chart â”€â”€â”€
function renderChart() {
  const canvas = document.getElementById('priceChart');
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  ctx.scale(2, 2);
  const W = rect.width, H = rect.height;
  
  ctx.fillStyle = '#0a0e17';
  ctx.fillRect(0, 0, W, H);
  
  if (priceHistory.length < 2) {
    ctx.fillStyle = '#6b7280';
    ctx.font = '13px Outfit';
    ctx.textAlign = 'center';
    ctx.fillText('ê°€ê²© ë°ì´í„° ìˆ˜ì§‘ ì¤‘...', W / 2, H / 2);
    return;
  }
  
  const prices = priceHistory.map(p => p.price);
  const min = Math.min(...prices) * 0.999;
  const max = Math.max(...prices) * 1.001;
  const range = max - min || 1;
  
  const padL = 60, padR = 10, padT = 20, padB = 30;
  const cW = W - padL - padR, cH = H - padT - padB;
  
  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,.04)';
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 5; i++) {
    const y = padT + (cH / 5) * i;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
    const val = max - (range / 5) * i;
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText(val.toFixed(4), padL - 6, y + 3);
  }
  
  // Price line
  const gradient = ctx.createLinearGradient(0, padT, 0, H - padB);
  gradient.addColorStop(0, 'rgba(0,230,118,.15)');
  gradient.addColorStop(1, 'rgba(0,230,118,0)');
  
  ctx.beginPath();
  ctx.moveTo(padL, padT + cH);
  prices.forEach((p, i) => {
    const x = padL + (i / (prices.length - 1)) * cW;
    const y = padT + (1 - (p - min) / range) * cH;
    ctx.lineTo(x, y);
  });
  ctx.lineTo(padL + cW, padT + cH);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // Line
  ctx.beginPath();
  prices.forEach((p, i) => {
    const x = padL + (i / (prices.length - 1)) * cW;
    const y = padT + (1 - (p - min) / range) * cH;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#00e676';
  ctx.lineWidth = 1.5;
  ctx.shadowColor = '#00e676';
  ctx.shadowBlur = 6;
  ctx.stroke();
  ctx.shadowBlur = 0;
  
  // Current price dot
  const lastPrice = prices[prices.length - 1];
  const lastX = padL + cW;
  const lastY = padT + (1 - (lastPrice - min) / range) * cH;
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#00e676';
  ctx.fill();
  ctx.beginPath();
  ctx.arc(lastX, lastY, 7, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(0,230,118,.3)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

// â”€â”€â”€ Swap Logic â”€â”€â”€
function previewSwap() {
  const amount = parseFloat(document.getElementById('swapAmount').value);
  if (!amount || amount <= 0) {
    document.getElementById('swapPreview').style.display = 'none';
    document.getElementById('swapOut').value = '';
    document.getElementById('swapBtn').disabled = true;
    return;
  }
  
  const pool = pools.find(p => p.id === selectedPool);
  if (!pool) return;
  
  const [tA, tB] = selectedPool.split('-');
  let rIn, rOut, tokenInSym, tokenOutSym;
  if (swapDirection === 'AtoB') {
    rIn = pool.reserveA; rOut = pool.reserveB;
    tokenInSym = tA; tokenOutSym = tB;
  } else {
    rIn = pool.reserveB; rOut = pool.reserveA;
    tokenInSym = tB; tokenOutSym = tA;
  }
  
  const fee = amount * (pool.feeBps / 10000);
  const amountAfterFee = amount - fee;
  const amountOut = (rOut * amountAfterFee) / (rIn + amountAfterFee);
  const idealOut = (rOut / rIn) * amount;
  const slippage = idealOut > 0 ? ((idealOut - amountOut) / idealOut) : 0;
  const rate = amountOut / amount;
  const minOut = amountOut * 0.995; // 0.5% slippage tolerance
  
  document.getElementById('swapOut').value = amountOut.toFixed(4);
  document.getElementById('prevRate').textContent = `1 ${tokenInSym} = ${rate.toFixed(6)} ${tokenOutSym}`;
  document.getElementById('prevFee').textContent = `${fee.toFixed(4)} ${tokenInSym}`;
  document.getElementById('prevSlip').textContent = (slippage * 100).toFixed(3) + '%';
  document.getElementById('prevMin').textContent = `${minOut.toFixed(4)} ${tokenOutSym}`;
  document.getElementById('swapPreview').style.display = 'block';
  document.getElementById('swapBtn').disabled = false;
  
  // Check balance
  const bal = balances[tokenInSym] || 0;
  if (amount > bal) {
    document.getElementById('swapBtn').disabled = true;
    document.getElementById('swapBtn').textContent = 'ì”ì•¡ ë¶€ì¡±';
  } else {
    document.getElementById('swapBtn').textContent = `${fmtN(amount, 2)} ${tokenInSym} â†’ ${fmtN(amountOut, 4)} ${tokenOutSym}`;
  }
}

function flipSwap() {
  swapDirection = swapDirection === 'AtoB' ? 'BtoA' : 'AtoB';
  const [tA, tB] = selectedPool.split('-');
  if (swapDirection === 'AtoB') {
    document.getElementById('swapInUnit').textContent = tA;
    document.getElementById('swapOutUnit').textContent = tB;
  } else {
    document.getElementById('swapInUnit').textContent = tB;
    document.getElementById('swapOutUnit').textContent = tA;
  }
  previewSwap();
}

function setMaxSwap() {
  const [tA, tB] = selectedPool.split('-');
  const token = swapDirection === 'AtoB' ? tA : tB;
  const bal = balances[token] || 0;
  document.getElementById('swapAmount').value = bal;
  previewSwap();
}

async function executeSwap() {
  const amount = parseFloat(document.getElementById('swapAmount').value);
  if (!amount) return;
  
  const [tA, tB] = selectedPool.split('-');
  const tokenIn = swapDirection === 'AtoB' ? tA : tB;
  
  document.getElementById('swapBtn').disabled = true;
  document.getElementById('swapBtn').textContent = 'ì²˜ë¦¬ ì¤‘...';
  
  try {
    const result = await postJSON('/api/dex/swap', {
      user: 'user1', poolId: selectedPool, tokenIn, amount: Math.floor(amount)
    });
    
    if (result.success) {
      document.getElementById('swapAmount').value = '';
      document.getElementById('swapOut').value = '';
      document.getElementById('swapPreview').style.display = 'none';
      document.getElementById('swapBtn').textContent = 'âœ“ ì™„ë£Œ!';
      setTimeout(() => { document.getElementById('swapBtn').textContent = 'ìŠ¤ì™‘ ì‹¤í–‰'; document.getElementById('swapBtn').disabled = true; }, 1500);
      loadBalances();
      loadPools();
    } else {
      alert('ìŠ¤ì™‘ ì‹¤íŒ¨: ' + (result.error || 'Unknown'));
      document.getElementById('swapBtn').textContent = 'ìŠ¤ì™‘ ì‹¤í–‰';
      document.getElementById('swapBtn').disabled = false;
    }
  } catch(e) {
    alert('ì˜¤ë¥˜: ' + e.message);
    document.getElementById('swapBtn').textContent = 'ìŠ¤ì™‘ ì‹¤í–‰';
    document.getElementById('swapBtn').disabled = false;
  }
}

// â”€â”€â”€ Limit Order Logic â”€â”€â”€
function setLimitSide(side) {
  limitSide = side;
  document.getElementById('limitBuyBtn').classList.toggle('active', side === 'buy');
  document.getElementById('limitBuyBtn').classList.toggle('buy-side', side === 'buy');
  document.getElementById('limitSellBtn').classList.toggle('active', side === 'sell');
  document.getElementById('limitSellBtn').classList.toggle('sell-side', side === 'sell');
  
  const btn = document.getElementById('limitBtn');
  if (side === 'buy') { btn.className = 'trade-btn buy'; btn.textContent = 'ë§¤ìˆ˜ ì£¼ë¬¸'; }
  else { btn.className = 'trade-btn sell'; btn.textContent = 'ë§¤ë„ ì£¼ë¬¸'; }
  updateLimitTotal();
}

function updateLimitTotal() {
  const price = parseFloat(document.getElementById('limitPrice').value) || 0;
  const amount = parseFloat(document.getElementById('limitAmount').value) || 0;
  const [, tB] = selectedPool.split('-');
  document.getElementById('limitTotal').textContent = `${fmtN(price * amount, 4)} ${tB}`;
}

document.getElementById('limitPrice').addEventListener('input', updateLimitTotal);
document.getElementById('limitAmount').addEventListener('input', updateLimitTotal);

async function executeLimitOrder() {
  const price = parseFloat(document.getElementById('limitPrice').value);
  const amount = parseInt(document.getElementById('limitAmount').value);
  if (!price || !amount) return alert('ê°€ê²©ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”');
  
  const btn = document.getElementById('limitBtn');
  btn.disabled = true;
  btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
  
  try {
    const result = await postJSON('/api/dex/order', {
      user: 'user1', poolId: selectedPool, side: limitSide, price, amount
    });
    
    btn.textContent = 'âœ“ ì£¼ë¬¸ ì™„ë£Œ!';
    setTimeout(() => { setLimitSide(limitSide); btn.disabled = false; }, 1500);
    document.getElementById('limitPrice').value = '';
    document.getElementById('limitAmount').value = '';
    loadOrderbook();
    loadBalances();
  } catch(e) {
    alert('ì£¼ë¬¸ ì‹¤íŒ¨: ' + e.message);
    setLimitSide(limitSide);
    btn.disabled = false;
  }
}

// â”€â”€â”€ Tab Switching â”€â”€â”€
document.querySelectorAll('.trade-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.trade-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('swapTab').style.display = tab.dataset.tab === 'swap' ? 'block' : 'none';
    document.getElementById('limitTab').style.display = tab.dataset.tab === 'limit' ? 'block' : 'none';
  });
});

// â”€â”€â”€ Utils â”€â”€â”€
function fmtN(n, d = 2) {
  if (n == null || isNaN(n)) return '0';
  return Number(n).toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });
}

function fmtCompact(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

// â”€â”€â”€ Resize â”€â”€â”€
window.addEventListener('resize', () => renderChart());

// â”€â”€â”€ Init â”€â”€â”€
async function init() {
  connectWS();
  await loadPools();
  await loadBalances();
  await loadOrderbook();
  await loadHistory();
  renderChart();
}

init();
</script>
</body>
</html>
