<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crowny Exchange â€” DEX + Trading AI</title>
<style>
:root { --bg: #0a0e17; --card: #111827; --border: #1e293b; --accent: #22d3ee; --green: #10b981; --red: #ef4444; --orange: #f59e0b; --text: #e2e8f0; --dim: #64748b; --blue: #3b82f6; }
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'SF Mono', 'Fira Code', monospace; background: var(--bg); color: var(--text); min-height:100vh; }
.header { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); padding: 12px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid var(--border); }
.logo { display:flex; align-items:center; gap:10px; }
.logo svg { width:28px; height:28px; }
.logo span { font-size:16px; font-weight:700; background: linear-gradient(135deg, var(--accent), var(--green)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo .ver { font-size:10px; color:var(--dim); -webkit-text-fill-color:var(--dim); margin-left:4px; }
.ctp-badge { font-size:10px; background: rgba(34,211,238,0.1); color:var(--accent); padding:3px 8px; border-radius:4px; border:1px solid rgba(34,211,238,0.2); }
.status { display:flex; gap:12px; align-items:center; font-size:11px; }
.status .dot { width:6px; height:6px; border-radius:50%; background:var(--green); display:inline-block; }
.tabs { display:flex; background: var(--card); border-bottom:1px solid var(--border); }
.tab { padding:10px 20px; cursor:pointer; font-size:12px; color:var(--dim); border-bottom:2px solid transparent; transition:all 0.2s; }
.tab:hover { color:var(--text); background:rgba(255,255,255,0.02); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.main { display:flex; height: calc(100vh - 90px); overflow:hidden; }
.panel { flex:1; overflow-y:auto; padding:16px; }
.panel::-webkit-scrollbar { width:4px; }
.panel::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
.sidebar { width:320px; border-left:1px solid var(--border); overflow-y:auto; padding:12px; background:rgba(0,0,0,0.2); }
.card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:14px; margin-bottom:12px; }
.card-title { font-size:11px; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.stat-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:8px; }
.stat { background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; }
.stat .label { font-size:10px; color:var(--dim); }
.stat .value { font-size:18px; font-weight:700; margin-top:2px; }
.stat .change { font-size:10px; margin-top:2px; }
.stat .change.up { color:var(--green); }
.stat .change.down { color:var(--red); }
.pool-row { display:flex; align-items:center; padding:10px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.2s; }
.pool-row:hover { background:rgba(34,211,238,0.05); }
.pool-row .pair { font-weight:600; font-size:13px; min-width:120px; }
.pool-row .price { font-size:13px; min-width:100px; text-align:right; }
.pool-row .vol { font-size:11px; color:var(--dim); min-width:80px; text-align:right; }
.pool-row .trit { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; margin-right:8px; }
.trit-p { background:rgba(16,185,129,0.2); color:var(--green); }
.trit-o { background:rgba(245,158,11,0.2); color:var(--orange); }
.trit-t { background:rgba(239,68,68,0.2); color:var(--red); }
.btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-family:inherit; transition:all 0.2s; }
.btn-primary { background:var(--accent); color:#000; font-weight:600; }
.btn-primary:hover { background:#06b6d4; }
.btn-green { background:var(--green); color:#000; font-weight:600; }
.btn-red { background:var(--red); color:#fff; font-weight:600; }
.btn-sm { padding:5px 10px; font-size:11px; }
.input { background:rgba(0,0,0,0.4); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:6px; font-size:12px; font-family:inherit; width:100%; }
.input:focus { outline:none; border-color:var(--accent); }
select.input { appearance:none; }
.form-row { display:flex; gap:8px; margin-bottom:8px; }
.form-row > * { flex:1; }
.form-label { font-size:10px; color:var(--dim); margin-bottom:4px; display:block; }
.ai-signal { display:flex; align-items:center; gap:12px; padding:16px; border-radius:8px; margin-bottom:12px; }
.ai-signal.buy { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); }
.ai-signal.sell { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); }
.ai-signal.hold { background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); }
.ai-trit { font-size:32px; font-weight:700; }
.ai-detail { flex:1; }
.ai-detail .title { font-size:14px; font-weight:600; }
.ai-detail .sub { font-size:11px; color:var(--dim); margin-top:2px; }
.strategy-row { display:flex; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.03); font-size:11px; }
.strategy-row .name { min-width:80px; color:var(--dim); }
.strategy-row .sig { min-width:50px; font-weight:600; }
.strategy-row .conf { min-width:40px; color:var(--dim); text-align:right; }
.strategy-row .reason { flex:1; padding-left:8px; font-size:10px; }
.chart-container { background:rgba(0,0,0,0.3); border-radius:6px; padding:8px; margin:8px 0; height:200px; position:relative; overflow:hidden; }
canvas { width:100%!important; height:100%!important; }
.orderbook { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.ob-side { font-size:11px; }
.ob-row { display:flex; justify-content:space-between; padding:2px 4px; position:relative; }
.ob-row .bar { position:absolute; top:0; height:100%; opacity:0.1; }
.ob-ask .bar { right:0; background:var(--red); }
.ob-bid .bar { left:0; background:var(--green); }
.ob-price { z-index:1; position:relative; }
.ob-size { z-index:1; position:relative; color:var(--dim); }
.backtest-result { background:rgba(0,0,0,0.3); padding:12px; border-radius:6px; }
.bt-stat { display:inline-block; margin:4px 8px 4px 0; font-size:12px; }
.bt-label { color:var(--dim); font-size:10px; }
.premium-badge { padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.premium-positive { background:rgba(239,68,68,0.15); color:var(--red); }
.premium-negative { background:rgba(16,185,129,0.15); color:var(--green); }
.hidden { display:none; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.pulse { animation: pulse 2s infinite; }
.loading { text-align:center; padding:40px; color:var(--dim); }
.mini-chart { height:40px; display:flex; align-items:end; gap:1px; }
.mini-bar { width:3px; min-height:1px; border-radius:1px 1px 0 0; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <svg viewBox="0 0 100 100"><polygon points="50,10 90,80 10,80" fill="none" stroke="url(#g1)" stroke-width="4"/><defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#22d3ee"/><stop offset="100%" style="stop-color:#10b981"/></linearGradient></defs></svg>
    <span>CROWNY EXCHANGE <span class="ver">v1.0</span></span>
    <span class="ctp-badge">CTP-T â–³â—‹â–½</span>
  </div>
  <div class="status">
    <span><span class="dot"></span> DEX</span>
    <span><span class="dot"></span> AI</span>
    <span id="wsStatus"><span class="dot" style="background:var(--orange)"></span> WS</span>
    <span id="premiumBadge" class="premium-badge premium-positive">ê¹€í”„ ---%</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="dex">ğŸ’± DEX</div>
  <div class="tab" data-tab="trading">ğŸ¤– Trading AI</div>
  <div class="tab" data-tab="market">ğŸ“Š Market</div>
  <div class="tab" data-tab="portfolio">ğŸ’¼ Portfolio</div>
</div>

<!-- â•â•â• DEX TAB â•â•â• -->
<div id="tab-dex" class="main">
  <div class="panel">
    <div class="stat-grid" id="dexStats"></div>

    <div class="card" style="margin-top:12px">
      <div class="card-title">ìœ ë™ì„± í’€</div>
      <div id="poolList"></div>
    </div>

    <div class="card">
      <div class="card-title">ìµœê·¼ ê±°ë˜</div>
      <div id="swapHistory" style="max-height:300px;overflow-y:auto;font-size:11px"></div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card">
      <div class="card-title">ìŠ¤ì™‘</div>
      <div class="form-row">
        <div><label class="form-label">í’€</label><select class="input" id="swapPool"></select></div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ì…ë ¥ í† í°</label><select class="input" id="swapTokenIn"></select></div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ìˆ˜ëŸ‰</label><input class="input" id="swapAmount" type="number" placeholder="0"></div>
      </div>
      <div id="swapPreview" style="font-size:11px;color:var(--dim);padding:8px 0"></div>
      <button class="btn btn-primary" style="width:100%" onclick="executeSwap()">ìŠ¤ì™‘ ì‹¤í–‰</button>
    </div>

    <div class="card">
      <div class="card-title">ë¦¬ë°‹ ì£¼ë¬¸</div>
      <div class="form-row">
        <div><label class="form-label">í’€</label><select class="input" id="orderPool"></select></div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ë°©í–¥</label>
          <select class="input" id="orderSide"><option value="buy">ë§¤ìˆ˜</option><option value="sell">ë§¤ë„</option></select>
        </div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ê°€ê²©</label><input class="input" id="orderPrice" type="number" step="0.0001"></div>
        <div><label class="form-label">ìˆ˜ëŸ‰</label><input class="input" id="orderAmount" type="number"></div>
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="placeOrder()">ì£¼ë¬¸</button>
    </div>

    <div class="card">
      <div class="card-title">ì˜¤ë”ë¶ <span id="obPool" style="color:var(--accent)">CRWN-USDT</span></div>
      <div class="orderbook" id="orderbook"></div>
    </div>
  </div>
</div>

<!-- â•â•â• TRADING AI TAB â•â•â• -->
<div id="tab-trading" class="main hidden">
  <div class="panel">
    <div class="card">
      <div class="card-title">AI ë¶„ì„ ì„¤ì •</div>
      <div class="form-row">
        <div><label class="form-label">ê±°ë˜ì†Œ</label>
          <select class="input" id="aiExchange"><option value="binance">Binance</option><option value="upbit">Upbit</option></select>
        </div>
        <div><label class="form-label">ì‹¬ë³¼</label>
          <select class="input" id="aiSymbol">
            <option value="BTCUSDT">BTC/USDT</option><option value="ETHUSDT">ETH/USDT</option>
            <option value="XRPUSDT">XRP/USDT</option><option value="SOLUSDT">SOL/USDT</option>
            <option value="DOGEUSDT">DOGE/USDT</option><option value="ADAUSDT">ADA/USDT</option>
          </select>
        </div>
        <div><label class="form-label">ì¸í„°ë²Œ</label>
          <select class="input" id="aiInterval"><option value="15m">15ë¶„</option><option value="1h" selected>1ì‹œê°„</option><option value="4h">4ì‹œê°„</option><option value="1d">1ì¼</option></select>
        </div>
        <div style="display:flex;align-items:end;gap:6px">
          <button class="btn btn-primary" onclick="runAnalysis()">ğŸ” ë¶„ì„</button>
          <button class="btn btn-green btn-sm" onclick="runBacktest()">ğŸ“Š ë°±í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
    </div>

    <div id="aiResult"></div>
    <div id="backtestResult"></div>

    <div class="card">
      <div class="card-title">ë©€í‹° ì‹¬ë³¼ ìŠ¤ìº”</div>
      <button class="btn btn-primary btn-sm" onclick="runMultiScan()">ì „ì²´ ìŠ¤ìº”</button>
      <div id="multiScanResult" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card">
      <div class="card-title">AI ì „ëµ (3-Trit Consensus)</div>
      <div style="font-size:11px; line-height:1.8">
        <div>ğŸ“Š <b>RSI</b> â€” ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ (ê°€ì¤‘ì¹˜ 1.5Ã—)</div>
        <div>ğŸ“ˆ <b>MACD</b> â€” ê³¨ë“ /ë°ë“œí¬ë¡œìŠ¤ (1.3Ã—)</div>
        <div>ğŸ“‰ <b>Bollinger</b> â€” ë°´ë“œ í„°ì¹˜/ìˆ˜ì¶• (1.2Ã—)</div>
        <div>ğŸ“Š <b>Volume</b> â€” ê±°ë˜ëŸ‰ ì´ìƒì¹˜ (0.8Ã—)</div>
        <div>ğŸ“ <b>Trend</b> â€” EMA ì •ë°°ì—´/ì—­ë°°ì—´ (1.0Ã—)</div>
        <div>ğŸ”„ <b>Stochastic</b> â€” K/D êµì°¨ (0.7Ã—)</div>
      </div>
      <div style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:4px;font-size:10px">
        <div>P(+1) = ë§¤ìˆ˜ | O(0) = ê´€ë§ | T(-1) = ë§¤ë„</div>
        <div>Score &gt; 0.3 â†’ ë§¤ìˆ˜ | Score &lt; -0.3 â†’ ë§¤ë„</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ë¦¬ìŠ¤í¬ ê´€ë¦¬</div>
      <div style="font-size:11px; line-height:1.8">
        <div>ğŸ›¡ í¬ì§€ì…˜ í•œë„: 10%</div>
        <div>ğŸ”» ì†ì ˆ: -3%</div>
        <div>ğŸ”º ìµì ˆ: +6%</div>
        <div>ğŸ“… ì¼ì¼ ê±°ë˜ ì œí•œ: 10íšŒ</div>
        <div>âš ï¸ ìµœëŒ€ ë“œë¡œë‹¤ìš´: 15%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Upbit ì‹¬ë³¼ (KRW ë§ˆì¼“)</div>
      <div style="font-size:10px; color:var(--dim)">
        ë¶„ì„ ì‹œ exchange=upbit ì„ íƒ í›„<br>
        ì‹¬ë³¼: KRW-BTC, KRW-ETH ë“±<br>
        (ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• MARKET TAB â•â•â• -->
<div id="tab-market" class="main hidden">
  <div class="panel">
    <div class="card">
      <div class="card-title">ì‹¤ì‹œê°„ ì‹œì„¸ (Upbit + Binance)</div>
      <button class="btn btn-primary btn-sm" onclick="fetchPrices()" style="margin-bottom:8px">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <div id="marketPrices"></div>
    </div>

    <div class="card">
      <div class="card-title">ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</div>
      <div id="kimchiPremium" style="font-size:24px;font-weight:700;padding:16px;text-align:center">---</div>
    </div>
  </div>

  <div class="sidebar">
    <div class="card">
      <div class="card-title">ë¹ ë¥¸ ì¡°íšŒ</div>
      <div class="form-row">
        <div><label class="form-label">ê±°ë˜ì†Œ</label><select class="input" id="qExchange"><option value="binance">Binance</option><option value="upbit">Upbit</option></select></div>
      </div>
      <div class="form-row">
        <div><label class="form-label">ì‹¬ë³¼</label><input class="input" id="qSymbol" value="BTCUSDT"></div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="quickLookup()">ì¡°íšŒ</button>
      <div id="quickResult" style="margin-top:8px;font-size:11px"></div>
    </div>
  </div>
</div>

<!-- â•â•â• PORTFOLIO TAB â•â•â• -->
<div id="tab-portfolio" class="main hidden">
  <div class="panel">
    <div class="card">
      <div class="card-title">ë‚´ ì”ì•¡ (DEX)</div>
      <div id="myBalances"></div>
    </div>
    <div class="card">
      <div class="card-title">LP í¬ì§€ì…˜</div>
      <div id="myLPPositions" style="font-size:12px;color:var(--dim)">ìœ ë™ì„± ê³µê¸‰ ë‚´ì—­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>
  </div>
  <div class="sidebar">
    <div class="card">
      <div class="card-title">API ì„¤ì •</div>
      <div class="form-row"><div><label class="form-label">Upbit Access Key</label><input class="input" id="upbitKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>
      <div class="form-row"><div><label class="form-label">Upbit Secret Key</label><input class="input" id="upbitSecret" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>
      <div class="form-row"><div><label class="form-label">Binance API Key</label><input class="input" id="binanceKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>
      <div class="form-row"><div><label class="form-label">Binance Secret</label><input class="input" id="binanceSecret" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div></div>
      <button class="btn btn-primary btn-sm" onclick="saveApiKeys()">ì €ì¥</button>
      <div style="font-size:10px;color:var(--dim);margin-top:6px">* í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let ws;

// â•â•â• Tab Navigation â•â•â•
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.main').forEach(m => m.classList.add('hidden'));
    tab.classList.add('active');
    document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
  });
});

// â•â•â• WebSocket â•â•â•
function connectWS() {
  const wsUrl = `ws://${window.location.host}`;
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="dot"></span> WS';
    ws.send(JSON.stringify({ type: 'subscribe_prices' }));
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'dex_update') updateDexPrices(msg.data);
    if (msg.type === 'prices') updateMarketPrices(msg.data);
    if (msg.type === 'swap') addSwapToHistory(msg.data);
  };
  ws.onclose = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="dot" style="background:var(--red)"></span> WS';
    setTimeout(connectWS, 3000);
  };
}

// â•â•â• Fetch Helpers â•â•â•
async function api(path) {
  try { const r = await fetch(API + path); return r.json(); } catch(e) { return { error: e.message }; }
}
async function apiPost(path, data) {
  try { const r = await fetch(API + path, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) }); return r.json(); } catch(e) { return { error: e.message }; }
}

// â•â•â• DEX Functions â•â•â•
async function loadDex() {
  const [summary, pools, balances] = await Promise.all([
    api('/api/dex/summary'), api('/api/dex/pools'), api('/api/dex/balances?user=user1')
  ]);

  // Stats
  document.getElementById('dexStats').innerHTML = `
    <div class="stat"><div class="label">í† í°</div><div class="value">${summary.tokens || 0}</div></div>
    <div class="stat"><div class="label">í’€</div><div class="value">${summary.pools || 0}</div></div>
    <div class="stat"><div class="label">ìŠ¤ì™‘</div><div class="value">${(summary.swaps || 0).toLocaleString()}</div></div>
    <div class="stat"><div class="label">ì´ ê±°ë˜ëŸ‰</div><div class="value">${(summary.totalVolume || 0).toLocaleString()}</div></div>
    <div class="stat"><div class="label">ì´ ìˆ˜ìˆ˜ë£Œ</div><div class="value">${(summary.totalFees || 0).toLocaleString()}</div></div>
    <div class="stat"><div class="label">ì£¼ë¬¸</div><div class="value">${summary.orders || 0}</div></div>
  `;

  // Pools
  if (pools.pools) {
    document.getElementById('poolList').innerHTML = pools.pools.map(p => `
      <div class="pool-row" onclick="selectPool('${p.id}')">
        <div class="trit ${p.swapCount > 0 ? 'trit-p' : 'trit-o'}">${p.swapCount > 0 ? 'P' : 'O'}</div>
        <div class="pair">${p.id}</div>
        <div class="price">${p.price < 0.001 ? p.price.toExponential(3) : p.price.toFixed(6)}</div>
        <div class="vol">${p.reserveA.toLocaleString()} / ${p.reserveB.toLocaleString()}</div>
        <div style="font-size:10px;color:var(--dim);margin-left:auto">swaps:${p.swapCount} fee:${p.fees}</div>
      </div>
    `).join('');

    // Populate swap/order pool selects
    const poolOpts = pools.pools.map(p => `<option value="${p.id}">${p.id}</option>`).join('');
    document.getElementById('swapPool').innerHTML = poolOpts;
    document.getElementById('orderPool').innerHTML = poolOpts;
    updateSwapTokens();
  }

  // Swap history
  const history = await api('/api/dex/history?limit=20');
  if (history.swaps) renderSwapHistory(history.swaps);

  // Balances
  if (balances.balances) renderBalances(balances.balances);
}

function updateSwapTokens() {
  const poolId = document.getElementById('swapPool').value;
  const [a, b] = poolId.split('-');
  document.getElementById('swapTokenIn').innerHTML = `<option value="${a}">${a}</option><option value="${b}">${b}</option>`;
}
document.getElementById('swapPool')?.addEventListener('change', updateSwapTokens);

async function executeSwap() {
  const pool = document.getElementById('swapPool').value;
  const tokenIn = document.getElementById('swapTokenIn').value;
  const amount = document.getElementById('swapAmount').value;
  if (!amount || amount <= 0) return alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”');
  const result = await apiPost('/api/dex/swap', { poolId: pool, tokenIn, amount: parseInt(amount) });
  if (result.success) {
    document.getElementById('swapPreview').innerHTML = `<span style="color:var(--green)">âœ“ ${result.result.amountIn} ${result.result.tokenIn} â†’ ${result.result.amountOut} ${result.result.tokenOut} (fee:${result.result.fee})</span>`;
    loadDex();
  } else {
    document.getElementById('swapPreview').innerHTML = `<span style="color:var(--red)">âœ— ${result.error}</span>`;
  }
}

async function placeOrder() {
  const pool = document.getElementById('orderPool').value;
  const side = document.getElementById('orderSide').value;
  const price = document.getElementById('orderPrice').value;
  const amount = document.getElementById('orderAmount').value;
  const result = await apiPost('/api/dex/order', { poolId: pool, side, price, amount: parseInt(amount) });
  if (result.order) alert(`ì£¼ë¬¸ ì™„ë£Œ: ${result.order.id}`);
  loadDex();
}

function selectPool(poolId) {
  document.getElementById('swapPool').value = poolId;
  document.getElementById('orderPool').value = poolId;
  document.getElementById('obPool').textContent = poolId;
  updateSwapTokens();
  loadOrderbook(poolId);
}

async function loadOrderbook(poolId) {
  const data = await api(`/api/dex/orderbook?pool=${poolId}`);
  if (!data.orders) return;
  const asks = data.orders.filter(o => o.side === 'sell').sort((a,b) => a.price - b.price);
  const bids = data.orders.filter(o => o.side === 'buy').sort((a,b) => b.price - a.price);
  document.getElementById('orderbook').innerHTML = `
    <div class="ob-side"><div style="color:var(--red);font-size:10px;margin-bottom:4px">ë§¤ë„(Ask)</div>
      ${asks.slice(0,8).map(a => `<div class="ob-row ob-ask"><span class="ob-price" style="color:var(--red)">${a.price.toFixed(6)}</span><span class="ob-size">${a.amount - a.filled}</span></div>`).join('')}
    </div>
    <div class="ob-side"><div style="color:var(--green);font-size:10px;margin-bottom:4px">ë§¤ìˆ˜(Bid)</div>
      ${bids.slice(0,8).map(b => `<div class="ob-row ob-bid"><span class="ob-price" style="color:var(--green)">${b.price.toFixed(6)}</span><span class="ob-size">${b.amount - b.filled}</span></div>`).join('')}
    </div>
  `;
}

function renderSwapHistory(swaps) {
  document.getElementById('swapHistory').innerHTML = swaps.reverse().map(s => {
    const trit = s.trit === 1 ? 'P' : s.trit === -1 ? 'T' : 'O';
    const cls = s.trit === 1 ? 'trit-p' : s.trit === -1 ? 'trit-t' : 'trit-o';
    return `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
      <span class="trit ${cls}" style="display:inline-flex;width:16px;height:16px;font-size:8px">${trit}</span>
      ${s.amountIn.toLocaleString()} ${s.tokenIn} â†’ ${s.amountOut.toLocaleString()} ${s.tokenOut}
      <span style="color:var(--dim);font-size:10px">fee:${s.fee} impact:${(s.impact*100).toFixed(2)}%</span>
    </div>`;
  }).join('');
}

function addSwapToHistory(swap) {
  const el = document.getElementById('swapHistory');
  const trit = swap.trit === 1 ? 'P' : swap.trit === -1 ? 'T' : 'O';
  const cls = swap.trit === 1 ? 'trit-p' : swap.trit === -1 ? 'trit-t' : 'trit-o';
  el.insertAdjacentHTML('afterbegin', `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
    <span class="trit ${cls}" style="display:inline-flex;width:16px;height:16px;font-size:8px">${trit}</span>
    ${swap.amountIn?.toLocaleString()} ${swap.tokenIn} â†’ ${swap.amountOut?.toLocaleString()} ${swap.tokenOut}
    <span style="color:var(--dim);font-size:10px">fee:${swap.fee}</span>
  </div>`);
}

function updateDexPrices(pools) {
  const rows = document.querySelectorAll('.pool-row');
  pools.forEach(p => {
    rows.forEach(row => {
      if (row.querySelector('.pair')?.textContent === p.id) {
        row.querySelector('.price').textContent = p.price < 0.001 ? p.price.toExponential(3) : p.price.toFixed(6);
      }
    });
  });
}

function renderBalances(bals) {
  document.getElementById('myBalances').innerHTML = Object.entries(bals)
    .filter(([k,v]) => v > 0)
    .map(([token, amount]) => `
      <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border)">
        <span style="font-weight:600">${token}</span>
        <span>${amount.toLocaleString()}</span>
      </div>
    `).join('');
}

// â•â•â• Trading AI Functions â•â•â•
async function runAnalysis() {
  const exchange = document.getElementById('aiExchange').value;
  const symbol = document.getElementById('aiSymbol').value;
  const interval = document.getElementById('aiInterval').value;
  document.getElementById('aiResult').innerHTML = '<div class="loading pulse">ë¶„ì„ ì¤‘... â–³â—‹â–½</div>';

  const data = await api(`/api/ai/analyze?exchange=${exchange}&symbol=${symbol}&interval=${interval}`);
  if (data.error) { document.getElementById('aiResult').innerHTML = `<div class="card" style="color:var(--red)">${data.error}</div>`; return; }

  const cls = data.decision === 'buy' ? 'buy' : data.decision === 'sell' ? 'sell' : 'hold';
  const emoji = data.trit === 1 ? 'ğŸŸ¢' : data.trit === -1 ? 'ğŸ”´' : 'ğŸŸ¡';
  const tritChar = data.trit === 1 ? 'â–³' : data.trit === -1 ? 'â–½' : 'â—‹';

  document.getElementById('aiResult').innerHTML = `
    <div class="ai-signal ${cls}">
      <div class="ai-trit">${emoji} ${tritChar}</div>
      <div class="ai-detail">
        <div class="title">${data.tritStr} â€” ${data.symbol}</div>
        <div class="sub">${data.reason}</div>
        <div class="sub">Price: $${data.price?.toLocaleString()} | Score: ${data.score} | Confidence: ${(data.confidence*100).toFixed(0)}%</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ì „ëµë³„ íŒë‹¨</div>
      ${(data.strategies || []).map(s => `
        <div class="strategy-row">
          <span class="name">${s.name}</span>
          <span class="sig" style="color:${s.signal==='ë§¤ìˆ˜'?'var(--green)':s.signal==='ë§¤ë„'?'var(--red)':'var(--orange)'}">${s.signal}</span>
          <span class="conf">${s.confidence}</span>
          <span class="reason">${s.reason}</span>
        </div>
      `).join('')}
    </div>
    ${data.risk ? `<div class="card">
      <div class="card-title">ë¦¬ìŠ¤í¬</div>
      <div style="font-size:11px">
        í—ˆìš©: ${data.risk.allowed ? 'âœ…' : 'âŒ'} | ë“œë¡œë‹¤ìš´: ${data.risk.drawdown}% | ìµœëŒ€ í¬ì§€ì…˜: ${data.risk.maxSize?.toLocaleString()}
        ${data.risk.risks?.map(r => `<div style="color:${r.level==='block'?'var(--red)':'var(--orange)'};margin-top:2px">âš  ${r.reason}</div>`).join('')||''}
      </div>
    </div>` : ''}
  `;
}

async function runBacktest() {
  const exchange = document.getElementById('aiExchange').value;
  const symbol = document.getElementById('aiSymbol').value;
  const interval = document.getElementById('aiInterval').value;
  document.getElementById('backtestResult').innerHTML = '<div class="loading pulse">ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</div>';

  const data = await api(`/api/ai/backtest?exchange=${exchange}&symbol=${symbol}&interval=${interval}&balance=10000000`);
  if (data.error) { document.getElementById('backtestResult').innerHTML = `<div class="card" style="color:var(--red)">${data.error}</div>`; return; }

  const retColor = parseFloat(data.totalReturn) >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('backtestResult').innerHTML = `
    <div class="card">
      <div class="card-title">ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ â€” ${data.symbol} (${data.interval})</div>
      <div class="backtest-result">
        <div class="bt-stat"><div class="bt-label">ì´ˆê¸° ìì‚°</div><div>${data.initialBalance?.toLocaleString()}</div></div>
        <div class="bt-stat"><div class="bt-label">ìµœì¢… ìì‚°</div><div style="color:${retColor};font-weight:700">${data.finalBalance?.toLocaleString()}</div></div>
        <div class="bt-stat"><div class="bt-label">ìˆ˜ìµë¥ </div><div style="color:${retColor};font-weight:700;font-size:18px">${data.totalReturn}</div></div>
        <div class="bt-stat"><div class="bt-label">ê±°ë˜ ìˆ˜</div><div>${data.totalTrades}</div></div>
        <div class="bt-stat"><div class="bt-label">ìŠ¹ë¥ </div><div>${data.winRate}</div></div>
        <div class="bt-stat"><div class="bt-label">ìŠ¹/íŒ¨</div><div style="color:var(--green)">${data.wins}</div> / <div style="color:var(--red)">${data.losses}</div></div>
        <div class="bt-stat"><div class="bt-label">ìµœëŒ€ ë“œë¡œë‹¤ìš´</div><div style="color:var(--red)">${data.maxDrawdown}</div></div>
        <div class="bt-stat"><div class="bt-label">ìƒ¤í”„ ë¹„ìœ¨</div><div>${data.sharpeRatio}</div></div>
      </div>
      ${data.equity ? `<div class="chart-container"><canvas id="equityChart"></canvas></div>` : ''}
    </div>
  `;

  if (data.equity) drawEquityChart(data.equity);
}

function drawEquityChart(equity) {
  const canvas = document.getElementById('equityChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.parentElement.clientWidth - 16;
  const h = 180;
  canvas.width = w; canvas.height = h;

  const min = Math.min(...equity);
  const max = Math.max(...equity);
  const range = max - min || 1;

  ctx.strokeStyle = equity[equity.length-1] >= equity[0] ? '#10b981' : '#ef4444';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  for (let i = 0; i < equity.length; i++) {
    const x = (i / (equity.length - 1)) * w;
    const y = h - ((equity[i] - min) / range) * (h - 20) - 10;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Fill
  ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
  ctx.fillStyle = equity[equity.length-1] >= equity[0] ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)';
  ctx.fill();

  // Labels
  ctx.fillStyle = '#64748b'; ctx.font = '10px monospace';
  ctx.fillText(max.toLocaleString(), 4, 14);
  ctx.fillText(min.toLocaleString(), 4, h - 4);
}

async function runMultiScan() {
  document.getElementById('multiScanResult').innerHTML = '<div class="loading pulse">ì „ì²´ ìŠ¤ìº” ì¤‘...</div>';
  const data = await api('/api/ai/multi-analyze?symbols=BTCUSDT,ETHUSDT,XRPUSDT,SOLUSDT,DOGEUSDT,ADAUSDT');
  if (!data.results) return;

  document.getElementById('multiScanResult').innerHTML = data.results.map(r => {
    const cls = r.decision === 'buy' ? 'buy' : r.decision === 'sell' ? 'sell' : 'hold';
    const emoji = r.trit === 1 ? 'ğŸŸ¢' : r.trit === -1 ? 'ğŸ”´' : 'ğŸŸ¡';
    return `<div class="ai-signal ${cls}" style="padding:8px;margin-bottom:4px">
      <span style="font-size:18px">${emoji}</span>
      <span style="font-weight:600;min-width:80px">${r.symbol}</span>
      <span style="font-size:12px">${r.tritStr}</span>
      <span style="font-size:11px;color:var(--dim);margin-left:auto">Score:${r.score} | $${r.price?.toLocaleString()}</span>
    </div>`;
  }).join('');
}

// â•â•â• Market Functions â•â•â•
async function fetchPrices() {
  document.getElementById('marketPrices').innerHTML = '<div class="loading pulse">ì‹œì„¸ ë¡œë”© ì¤‘...</div>';
  const data = await api('/api/market/prices');

  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  html += '<div><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px">ğŸ“Š Upbit (KRW)</div>';
  if (data.upbit) {
    Object.entries(data.upbit).forEach(([k,v]) => {
      const changeColor = v.changeRate >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span>${k}</span><span style="font-weight:600">â‚©${v.price?.toLocaleString()}</span>
        <span style="color:${changeColor}">${v.changeRate >= 0 ? '+' : ''}${(v.changeRate*100).toFixed(2)}%</span>
      </div>`;
    });
  }
  html += '</div><div><div style="font-size:12px;font-weight:600;color:var(--blue);margin-bottom:8px">ğŸ“Š Binance (USD)</div>';
  if (data.binance) {
    Object.entries(data.binance).forEach(([k,v]) => {
      const changeColor = v.changePercent >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span>${k}</span><span style="font-weight:600">$${v.price?.toLocaleString()}</span>
        <span style="color:${changeColor}">${v.changePercent >= 0 ? '+' : ''}${v.changePercent?.toFixed(2)}%</span>
      </div>`;
    });
  }
  html += '</div></div>';
  document.getElementById('marketPrices').innerHTML = html;

  // ê¹€í”„
  if (data.kimchiPremium) {
    const p = parseFloat(data.kimchiPremium.premium);
    const cls = p >= 0 ? 'premium-positive' : 'premium-negative';
    document.getElementById('kimchiPremium').innerHTML = `
      <div style="color:${p >= 0 ? 'var(--red)' : 'var(--green)'}">ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„: ${p >= 0 ? '+' : ''}${p}%</div>
      <div style="font-size:12px;color:var(--dim)">ì¶”ì • í™˜ìœ¨: â‚©${data.kimchiPremium.usdkrw}</div>
    `;
    document.getElementById('premiumBadge').textContent = `ê¹€í”„ ${p >= 0 ? '+' : ''}${p}%`;
    document.getElementById('premiumBadge').className = `premium-badge ${cls}`;
  }
}

function updateMarketPrices(data) {
  if (data.kimchiPremium) {
    const p = parseFloat(data.kimchiPremium.premium);
    document.getElementById('premiumBadge').textContent = `ê¹€í”„ ${p >= 0 ? '+' : ''}${p}%`;
  }
}

async function quickLookup() {
  const exchange = document.getElementById('qExchange').value;
  const symbol = document.getElementById('qSymbol').value;
  const candles = await api(`/api/market/candles?exchange=${exchange}&symbol=${symbol}&interval=1h&count=24`);
  if (candles.candles && candles.candles.length > 0) {
    const last = candles.candles[candles.candles.length - 1];
    const first = candles.candles[0];
    const change = ((last.close - first.open) / first.open * 100).toFixed(2);
    document.getElementById('quickResult').innerHTML = `
      <div style="padding:8px;background:rgba(0,0,0,0.3);border-radius:4px">
        <div style="font-weight:600">${symbol} (${exchange})</div>
        <div>í˜„ì¬: ${last.close.toLocaleString()}</div>
        <div>ê³ ê°€: ${Math.max(...candles.candles.map(c=>c.high)).toLocaleString()}</div>
        <div>ì €ê°€: ${Math.min(...candles.candles.map(c=>c.low)).toLocaleString()}</div>
        <div style="color:${change>=0?'var(--green)':'var(--red)'}">24h: ${change}%</div>
      </div>
    `;
  }
}

function saveApiKeys() { alert('API í‚¤ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ë°ëª¨)'); }

// â•â•â• Init â•â•â•
loadDex();
fetchPrices();
connectWS();
loadOrderbook('CRWN-USDT');
</script>
</body>
</html>
